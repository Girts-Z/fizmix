<!DOCTYPE html>
<html lang="lv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Fizmix mērījumu lietotne</title>
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <style>
    /* Fizmix brand colors from fizmix.lv (logo #017395) */
    :root {
      --fizmix-primary: #017395;
      --fizmix-primary-dark: #015a73;
      --fizmix-primary-light: #e0f2f7;
      --fizmix-bg: #f0f7f9;
      --fizmix-panel-border: rgba(1, 115, 149, 0.2);
    }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, sans-serif; margin: 0; padding: 16px; background: var(--fizmix-bg); color: #333; }
    h1 { margin-top: 0; color: var(--fizmix-primary); }
    .layout { display: flex; gap: 24px; max-width: 1400px; margin: 0 auto; }
    .col-left { flex: 0 0 30%; min-width: 280px; }
    .col-right { flex: 1 1 70%; min-width: 0; }
    .panel { background: #fff; border-radius: 8px; padding: 16px; margin-bottom: 16px; box-shadow: 0 1px 3px var(--fizmix-panel-border); border: 1px solid var(--fizmix-panel-border); }
    .panel h2 { margin: 0 0 12px; font-size: 1.1rem; color: var(--fizmix-primary); }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px; text-align: left; border: 1px solid #ddd; }
    th { background: var(--fizmix-primary-light); color: var(--fizmix-primary-dark); }
    input[type="number"] { width: 100%; padding: 6px; border: 1px solid #b8d4dc; border-radius: 4px; }
    input[type="number"]:focus { outline: none; border-color: var(--fizmix-primary); box-shadow: 0 0 0 2px rgba(1, 115, 149, 0.2); }
    button { padding: 6px 12px; cursor: pointer; background: var(--fizmix-primary); color: #fff; border: none; border-radius: 4px; }
    button:hover { background: var(--fizmix-primary-dark); }
    button.del { background: #c44; }
    button.del:hover { background: #a33; }
    .main-result-box { font-size: 1.5rem; font-weight: 700; color: #fff; margin: 12px 0 0; padding: 16px; background: var(--fizmix-primary); border: 2px solid var(--fizmix-primary-dark); border-radius: 8px; }
    .viz-row { display: flex; gap: 16px; align-items: flex-start; }
    .viz-row .chart { flex: 1; min-width: 0; }
    .muted { color: #5a6c73; font-size: 0.9rem; }
    .error { color: #c00; }
    .warn { color: #b8860b; }
  </style>
</head>
<body>
  <h1>Fizmix uzdevums</h1>
  <div class="layout">
    <div class="col-left">
      <div class="panel">
        <h2>Datu ievade</h2>
        <table id="dataTable">
          <thead>
            <tr>
              <th>Attālums, cm</th>
              <th>Apgaismojums, lx</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="dataBody"></tbody>
        </table>
        <button type="button" id="addRow">+ Pievienot rindu</button>
        <div id="resultArea"></div>
      </div>
    </div>
    <div class="col-right">
      <div class="panel viz-row">
        <div class="chart">
          <h2>Datu vizualizācija</h2>
          <div id="plotDiv" style="height: 500px;"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const defaultData = [];

    let dataRows = JSON.parse(localStorage.getItem('fizmix_data')) || defaultData.map(r => [...r]);

    function saveData() {
      localStorage.setItem('fizmix_data', JSON.stringify(dataRows));
    }

    function renderTable() {
      const tbody = document.getElementById('dataBody');
      tbody.innerHTML = '';
      dataRows.forEach((row, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="number" step="any" data-i="${i}" data-c="0" value="${row[0]}"></td>
          <td><input type="number" step="any" data-i="${i}" data-c="1" value="${row[1]}"></td>
          <td><button type="button" class="del" data-i="${i}">Dzēst</button></td>`;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll('input').forEach(inp => {
        inp.addEventListener('input', () => {
          const i = +inp.dataset.i, c = +inp.dataset.c;
          const v = parseFloat(inp.value);
          dataRows[i][c] = isNaN(v) ? '' : v;
          saveData();
          update();
        });
      });
      tbody.querySelectorAll('button.del').forEach(btn => {
        btn.addEventListener('click', () => {
          const i = +btn.dataset.i;
          dataRows.splice(i, 1);
          saveData();
          renderTable();
          update();
        });
      });
    }

    document.getElementById('addRow').addEventListener('click', () => {
      dataRows.push(['', '']);
      saveData();
      renderTable();
      update();
    });

    function getXY() {
      const x = [], y = [];
      dataRows.forEach(row => {
        const xi = parseFloat(row[0]), yi = parseFloat(row[1]);
        if (!isNaN(xi) && !isNaN(yi) && xi > 0) {
          x.push(xi);
          y.push(yi);
        }
      });
      return { x, y };
    }

    const API_RESULT = '/api/result';

    async function update() {
      const { x, y } = getXY();
      const resultArea = document.getElementById('resultArea');

      if (x.length < 2) {
        resultArea.innerHTML = '<p class="warn">Lūdzu ievadiet vismaz 2 derīgus datu punktus.</p>';
        if (x.length > 0) {
          Plotly.newPlot('plotDiv', [{
            x: x, y: y, mode: 'markers', type: 'scatter',
            marker: { size: 10, color: 'blue' }, name: 'Datu punkti'
          }], {
            title: 'Apgaismojums no attāluma',
            xaxis: { title: 'Attālums, cm' },
            yaxis: { title: 'Apgaismojums, lx' },
            template: 'plotly_white', height: 500
          }, { responsive: true });
        } else {
          document.getElementById('plotDiv').innerHTML = '<p class="muted">Ievadiet datus, lai redzētu grafiku.</p>';
        }
        return;
      }

      resultArea.innerHTML = '<p class="muted">Aprēķina…</p>';
      try {
        const res = await fetch(API_RESULT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ rows: dataRows.map(r => [r[0], r[1]]) })
        });
        const data = await res.json();
        if (!res.ok) {
          resultArea.innerHTML = `<p class="error">${data.error || res.statusText}</p>`;
          Plotly.newPlot('plotDiv', [{
            x: x, y: y, mode: 'markers', type: 'scatter',
            marker: { size: 10, color: 'blue' }, name: 'Datu punkti'
          }], {
            title: 'Apgaismojums no attāluma',
            xaxis: { title: 'Attālums, cm' },
            yaxis: { title: 'Apgaismojums, lx' },
            template: 'plotly_white', height: 500
          }, { responsive: true });
          return;
        }
        const mainResult = data.mainResult;
        const display = typeof mainResult === 'number' && isFinite(mainResult)
          ? mainResult.toFixed(6) : (mainResult == null ? '—' : String(mainResult));
        resultArea.innerHTML = `
          <p style="margin-bottom: 4px;"><strong>Galvenais rezultāts</strong></p>
          <div class="main-result-box"><strong>${display}</strong></div>
        `;
      } catch (err) {
        resultArea.innerHTML = '<p class="error">Tīkla kļūda. Izvietojiet Cloudflare Pages vai palaidiet ar lokālu backend.</p>';
      }

      Plotly.newPlot('plotDiv', [{
        x: x, y: y, mode: 'markers', type: 'scatter',
        marker: { size: 10, color: 'blue' }, name: 'Datu punkti'
      }], {
        title: 'Apgaismojums no attāluma',
        xaxis: { title: 'Attālums, cm' },
        yaxis: { title: 'Apgaismojums, lx' },
        template: 'plotly_white', height: 500, showlegend: true
      }, { responsive: true });
    }

    renderTable();
    update();
  </script>
</body>
</html>
